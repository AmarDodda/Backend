# CRM Backend Application

## Overview
This is a backend application for a Customer Relationship Management (CRM) system built with Express.js and MongoDB. It provides RESTful API endpoints to manage users, customers, communications, feedback, and queries. The application includes user authentication and various middleware for request processing and logging.

## Table of Contents
- [Usage](#usage)
- [API Endpoints](#api-endpoints)
- [Models](#models)
- [Middleware](#middleware)
- [License](#license)

## Usage
The backend server runs on `http://localhost:3001` by default. Make sure to configure your frontend application to interact with this server.

## API Endpoints

### User Routes
- `POST /users` - Register a new user
- `POST /users/login` - Log in a user
- `POST /users/logout` - Log out a user (authentication required)
- `GET /users/profile` - Get the profile of the logged-in user (authentication required)
- `PUT /users/profile` - Update the profile of the logged-in user (authentication required)
- `DELETE /users/profile` - Delete the profile of the logged-in user (authentication required)
- `GET /users` - Get all users (authentication and admin role required)
- `GET /users/:id` - Get a specific user by ID (authentication and admin role required)
- `PUT /users/:id` - Update a specific user by ID (authentication and admin role required)
- `DELETE /users/:id` - Delete a specific user by ID (authentication and admin role required)

### Customer Routes
- `POST /customers` - Create a new customer
- `GET /customers` - Get all customers
- `GET /customers/:id` - Get a specific customer by ID
- `PUT /customers/:id` - Update a customer by ID
- `DELETE /customers/:id` - Delete a customer by ID

### Consumer Routes
- `POST /api/consumers/consumerregister` - Register a new consumer
- `POST /api/consumers/consumerlogin` - Log in a consumer
- `GET /api/consumers/consumerlogin` - Log in a consumer (alternative route)
- `POST /api/consumers/consumerlogout` - Log out a consumer
- `GET /api/consumers/profile` - Get the profile of the logged-in consumer (consumer authentication required)

### Communication Routes
- `POST /communications/sendEmail/:customerId` - Send a combined email to a specific customer
- `GET /communications` - Get all communications

### Feedback Routes
- `POST /feedback` - Submit feedback
- `GET /feedback` - Get all feedbacks

### Query Routes
- `POST /query` - Submit a query
- `GET /query` - Get all queries

## Models

### User(admin)
The User model represents users of the CRM system, including their usernames, passwords, names, roles (user or admin), and the date they were created. This model handles user authentication and role-based access control.

### Customer
The Customer model represents customers within the CRM system. It includes details such as the associated consumer, customer name, email, purchase history (with product details, quantities, and prices), and preferences (fabric types, colors, designs).

### Communication
The Communication model tracks all communications with customers. It includes the customer reference, type of communication (email, feedback, query), subject, content, communication date, and email content.

### Feedback
The Feedback model stores feedback provided by consumers. It includes the consumer reference, consumer name, product details, rating, comment, and the date the feedback was submitted.

### Query
The Query model stores customer queries. It includes the consumer reference, consumer name, subject, message content, and the date the query was submitted.

### Consumer
The Consumer model represents the consumers using the CRM system. It includes their username, password, name, role (default is 'consumer'), and the date they were created. It also handles password comparison for authentication purposes. **The consumerId generated by the successful registration and login by the consumer via links sent through email, are added as the customerId when the admin enters the customer's information.**


## Middleware

### Auth Middleware
The `auth` middleware is used to handle authentication and authorization for the admin within the CRM system.

1. **checkAuth**:
   - This function verifies if the admin is authenticated by checking for a valid JWT token in the request cookies.
   - If the token is absent or invalid, it returns a 401 Unauthorized error.
   - Upon successful verification, it decodes the token to extract the user ID and attaches it to the request object before calling the next middleware.

2. **isAdmin**:
   - This function checks if the authenticated user has an admin role.
   - It retrieves the user ID from the request object, finds the user in the database, and checks their role.
   - If the user is not an admin, it returns a 403 Forbidden error.
   - If the user is an admin, it allows the request to proceed to the next middleware.

### Consumer Auth Middleware
The `consumerAuth` middleware is used to handle authentication for consumers within the CRM system.

1. **checkAuthConsumer**:
   - This function verifies if the consumer is authenticated by checking for a valid JWT token in the request cookies.
   - If the token is absent or invalid, it returns a 401 Unauthorized error.
   - Upon successful verification, it decodes the token to extract the consumer ID and attaches it to the request object before calling the next middleware.

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for more information.